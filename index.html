<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passkey Demo - Debug Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .debug-log {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.9);
        color: #0f0;
        padding: 15px;
        border-radius: 8px;
        max-width: 400px;
        max-height: 300px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .debug-log div {
        margin-bottom: 3px;
        padding: 2px 0;
    }

    .debug-log .error {
        color: #ff4444;
    }

    .debug-log .success {
        color: #44ff44;
    }

    .debug-log .info {
        color: #88ccff;
    }

    .debug-log .warning {
        color: #ffaa44;
    }

    .container {
        background: white;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        width: 100%;
    }

    h1 {
        font-size: 28px;
        margin-bottom: 8px;
        color: #1a1a1a;
    }

    .subtitle {
        color: #666;
        margin-bottom: 32px;
        font-size: 14px;
    }

    .input-group {
        margin-bottom: 24px;
    }

    label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
    }

    input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
    }

    input:focus {
        outline: none;
        border-color: #667eea;
    }

    button {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-bottom: 12px;
    }

    button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
        transform: translateY(0);
    }

    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .divider {
        text-align: center;
        margin: 24px 0;
        color: #999;
        font-size: 14px;
        position: relative;
    }

    .divider::before,
    .divider::after {
        content: '';
        position: absolute;
        top: 50%;
        width: 45%;
        height: 1px;
        background: #e0e0e0;
    }

    .divider::before {
        left: 0;
    }

    .divider::after {
        right: 0;
    }

    .status {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 16px;
        font-size: 14px;
        display: none;
    }

    .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }

    .status.show {
        display: block;
    }

    .welcome {
        text-align: center;
        padding: 32px;
    }

    .welcome h2 {
        color: #667eea;
        margin-bottom: 16px;
    }

    .welcome p {
        color: #666;
        margin-bottom: 24px;
    }

    #signOutBtn {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .hidden {
        display: none;
    }
</style>
```

</head>
<body>
    <div id="debugLog" class="debug-log"></div>

```
<div class="container">
    <div id="authSection">
        <h1>üîê Passkey Demo</h1>
        <p class="subtitle">Debug Version - See console for details</p>

        <div id="statusMessage" class="status"></div>

        <div class="input-group">
            <label for="username">Username</label>
            <input type="text" id="username" placeholder="Enter your username" autocomplete="username webauthn">
        </div>

        <button id="createPasskeyBtn">üîë Create Passkey & Sign In</button>

        <div class="divider">OR</div>

        <button id="signInBtn">üöÄ Sign In with Existing Passkey</button>
    </div>

    <div id="welcomeSection" class="hidden">
        <div class="welcome">
            <h2>üéâ Welcome!</h2>
            <p id="welcomeUsername"></p>
            <p>You're now signed in with your passkey.</p>
            <button id="signOutBtn">Sign Out</button>
        </div>
    </div>
</div>

<script>
    // Debug logging
    const debugLog = document.getElementById('debugLog');
    function log(message, type = 'info') {
        console.log(`[${type.toUpperCase()}] ${message}`);
        const div = document.createElement('div');
        div.className = type;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        debugLog.appendChild(div);
        debugLog.scrollTop = debugLog.scrollHeight;
    }

    function showStatus(message, type = 'info') {
        const statusEl = document.getElementById('statusMessage');
        statusEl.textContent = message;
        statusEl.className = `status ${type} show`;
        setTimeout(() => {
            statusEl.classList.remove('show');
        }, 5000);
    }

    // Check WebAuthn support
    log('Checking WebAuthn support...');
    if (!window.PublicKeyCredential) {
        log('WebAuthn NOT supported!', 'error');
        showStatus('Your browser does not support passkeys. Please use a modern browser.', 'error');
    } else {
        log('WebAuthn IS supported!', 'success');
    }

    // Initialize
    log('Page loaded, initializing...');
    const currentUser = localStorage.getItem('currentUser');
    if (currentUser) {
        log(`Found stored user: ${currentUser}`, 'info');
        showWelcome(currentUser);
    } else {
        log('No stored user found', 'info');
    }

    // Utility functions
    function bufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = '';
        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
    }

    function base64ToBuffer(base64) {
        const binary = window.atob(base64);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // Create Passkey
    document.getElementById('createPasskeyBtn').addEventListener('click', async function() {
        log('=== CREATE PASSKEY BUTTON CLICKED ===', 'info');
        
        const username = document.getElementById('username').value.trim();
        log(`Username input value: "${username}"`, 'info');
        
        if (!username) {
            log('Username is empty!', 'error');
            showStatus('Please enter a username', 'error');
            return;
        }

        log(`Creating passkey for user: ${username}`, 'info');
        showStatus('Creating your passkey...', 'info');

        try {
            log('Generating random challenge...', 'info');
            const challenge = new Uint8Array(32);
            crypto.getRandomValues(challenge);
            log('Challenge generated successfully', 'success');

            log('Generating random user ID...', 'info');
            const userId = new Uint8Array(16);
            crypto.getRandomValues(userId);
            log('User ID generated successfully', 'success');

            const publicKeyOptions = {
                challenge: challenge,
                rp: {
                    name: "Passkey Demo",
                    id: window.location.hostname,
                },
                user: {
                    id: userId,
                    name: username,
                    displayName: username,
                },
                pubKeyCredParams: [
                    { alg: -7, type: "public-key" },  // ES256
                    { alg: -257, type: "public-key" } // RS256
                ],
                authenticatorSelection: {
                    authenticatorAttachment: "platform",
                    requireResidentKey: true,
                    residentKey: "required",
                    userVerification: "required"
                },
                timeout: 60000,
                attestation: "none"
            };

            log('PublicKey options created:', 'info');
            log(JSON.stringify(publicKeyOptions, null, 2), 'info');

            log('Calling navigator.credentials.create()...', 'info');
            const credential = await navigator.credentials.create({
                publicKey: publicKeyOptions
            });

            log('Credential created successfully!', 'success');
            log(`Credential ID: ${credential.id}`, 'success');

            // Store credential
            const storedCredential = {
                id: credential.id,
                rawId: bufferToBase64(credential.rawId),
                type: credential.type,
                username: username
            };

            log('Storing credential in localStorage...', 'info');
            localStorage.setItem('passkey_' + username, JSON.stringify(storedCredential));
            localStorage.setItem('currentUser', username);
            log('Credential stored successfully!', 'success');

            showStatus('Passkey created successfully!', 'success');
            log('Showing welcome screen...', 'info');
            showWelcome(username);

        } catch (error) {
            log(`ERROR during passkey creation: ${error.name}`, 'error');
            log(`Error message: ${error.message}`, 'error');
            log(`Full error: ${JSON.stringify(error)}`, 'error');
            
            let errorMessage = 'Failed to create passkey. ';
            if (error.name === 'NotAllowedError') {
                errorMessage += 'User cancelled or timeout.';
            } else if (error.name === 'InvalidStateError') {
                errorMessage += 'Passkey already exists for this device.';
            } else {
                errorMessage += error.message;
            }
            
            showStatus(errorMessage, 'error');
        }
    });

    // Sign In
    document.getElementById('signInBtn').addEventListener('click', async function() {
        log('=== SIGN IN BUTTON CLICKED ===', 'info');
        
        showStatus('Authenticating with your passkey...', 'info');

        try {
            log('Generating random challenge...', 'info');
            const challenge = new Uint8Array(32);
            crypto.getRandomValues(challenge);
            log('Challenge generated successfully', 'success');

            const publicKeyOptions = {
                challenge: challenge,
                timeout: 60000,
                rpId: window.location.hostname,
                userVerification: "required"
            };

            log('PublicKey options for authentication:', 'info');
            log(JSON.stringify(publicKeyOptions, null, 2), 'info');

            log('Calling navigator.credentials.get()...', 'info');
            const credential = await navigator.credentials.get({
                publicKey: publicKeyOptions
            });

            log('Authentication successful!', 'success');
            log(`Credential ID: ${credential.id}`, 'success');

            // Find username from stored credentials
            log('Searching for matching credential in localStorage...', 'info');
            let foundUsername = null;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('passkey_')) {
                    const stored = JSON.parse(localStorage.getItem(key));
                    log(`Checking stored credential: ${stored.id}`, 'info');
                    if (stored.id === credential.id) {
                        foundUsername = stored.username;
                        log(`Match found! Username: ${foundUsername}`, 'success');
                        break;
                    }
                }
            }

            if (foundUsername) {
                localStorage.setItem('currentUser', foundUsername);
                showStatus('Signed in successfully!', 'success');
                log('Showing welcome screen...', 'info');
                showWelcome(foundUsername);
            } else {
                log('No matching credential found in storage!', 'warning');
                showStatus('Passkey verified but user not found', 'error');
            }

        } catch (error) {
            log(`ERROR during sign in: ${error.name}`, 'error');
            log(`Error message: ${error.message}`, 'error');
            log(`Full error: ${JSON.stringify(error)}`, 'error');
            
            let errorMessage = 'Failed to sign in. ';
            if (error.name === 'NotAllowedError') {
                errorMessage += 'User cancelled or no passkey available.';
            } else {
                errorMessage += error.message;
            }
            
            showStatus(errorMessage, 'error');
        }
    });

    // Sign Out
    document.getElementById('signOutBtn').addEventListener('click', function() {
        log('=== SIGN OUT CLICKED ===', 'info');
        localStorage.removeItem('currentUser');
        log('Current user removed from localStorage', 'info');
        showAuth();
        log('Showing auth screen', 'info');
    });

    function showWelcome(username) {
        log(`showWelcome() called for: ${username}`, 'info');
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('welcomeSection').classList.remove('hidden');
        document.getElementById('welcomeUsername').textContent = `Hello, ${username}! üëã`;
        log('Welcome screen displayed', 'success');
    }

    function showAuth() {
        log('showAuth() called', 'info');
        document.getElementById('authSection').classList.remove('hidden');
        document.getElementById('welcomeSection').classList.add('hidden');
        document.getElementById('username').value = '';
        log('Auth screen displayed', 'success');
    }

    log('Script initialization complete', 'success');
</script>
```

</body>
</html>
